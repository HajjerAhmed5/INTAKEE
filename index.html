<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>INTAKEE — Videos, Podcasts, and Clips</title>
  <meta name="description" content="INTAKEE is the all-in-one platform for videos, podcasts, and clips — freedom to create, simple to share.">
  <link rel="canonical" href="https://intakee.vercel.app/">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="INTAKEE — Videos, Podcasts, and Clips">
  <meta property="og:description" content="All-in-one platform for videos, podcasts, and clips.">
  <meta property="og:url" content="https://intakee.vercel.app/">
  <meta property="og:image" content="https://intakee.vercel.app/og-image.jpg">

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="INTAKEE — Videos, Podcasts, and Clips">
  <meta name="twitter:description" content="Share videos, clips, and podcasts — your voice, your space.">
  <meta name="twitter:image" content="https://intakee.vercel.app/og-image.jpg">

  <!-- Organization JSON-LD -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "INTAKEE",
    "url": "https://intakee.vercel.app/",
    "logo": "https://intakee.vercel.app/logo.png",
    "sameAs": []
  }
  </script>

  <!-- Icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet"/>
  <link rel="icon" href="/favicon.ico">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">

  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { background:#000; color:#fff; font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; }

    /* Header */
    header { display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:12px; padding:18px 16px; border-bottom:1px solid #111; }
    .brand { display:flex; align-items:center; gap:10px; }
    .brand img { height:100px; width:auto; border-radius:12px; } /* Big eye logo only */

    .search-bar{ display:flex; align-items:center; gap:8px; background:#0c0c0c; border:1px solid #2a2a2a; padding:8px 10px; border-radius:10px; max-width:520px; margin:0 auto; width:100%; }
    .search-bar input{ border:none; outline:none; background:transparent; color:#fff; width:100%; }

    .auth { display:flex; justify-content:flex-end; gap:10px; }

    /* Main */
    main { max-width:900px; margin:0 auto; padding:16px; padding-bottom:88px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input[type="text"], input[type="email"], input[type="password"] { flex:1; min-width:240px; padding:10px 12px; border-radius:10px; border:1px solid #2a2a2a; background:#0c0c0c; color:#fff; }
    input[type="file"] { color:#aaa; }
    button { padding:9px 14px; cursor:pointer; border-radius:10px; border:1px solid #2a2a2a; background:#141414; color:#fff; }
    button.primary { background:#0b63ff; border-color:#0b63ff; }
    button.ghost { background:transparent; }
    button.danger { background:#8b0000; border-color:#8b0000; }
    button[disabled] { opacity:.6; cursor:not-allowed; }
    .card { background:#0e0e0e; border:1px solid #1a1a1a; border-radius:14px; padding:14px; margin:12px 0; box-shadow: 0 4px 18px rgba(0,0,0,.35); }
    .post { display:grid; grid-template-columns:48px 1fr; gap:12px; }
    .avatar { width:48px; height:48px; border-radius:50%; background:#222; object-fit:cover; }
    .meta { display:flex; gap:8px; align-items:center; font-size:.9rem; opacity:.95; font-weight:600; }
    .media { margin-top:10px; }
    .media img, .media video { max-width:100%; border-radius:10px; display:block; }
    .media audio { width:100%; margin-top:6px; }
    .muted { opacity:.7; font-size:.85rem; color:#b5b5b5; }
    .actions { display:flex; gap:8px; margin-top:8px; }
    .comment { padding:8px 10px; background:#111; border-radius:8px; margin-top:6px; }

    /* Bottom nav */
    .bottom-nav{
      position:fixed; bottom:0; left:0; right:0; background:#0b0b0b; border-top:1px solid #151515;
      display:grid; grid-template-columns:repeat(7,1fr); gap:4px; padding:8px 6px; z-index:50;
    }
    .bottom-nav a{ color:#aaa; text-decoration:none; display:flex; flex-direction:column; align-items:center; gap:4px; font-size:.75rem; padding:6px 4px; border-radius:10px; }
    .bottom-nav a.active, .bottom-nav a:hover{ color:#fff; background:#111; }

    /* Modal (kept but hard-hidden) */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; z-index:200; }
    .modal-card{ background:#0e0e0e; border:1px solid #1a1a1a; border-radius:14px; padding:16px; width:min(420px,92vw); box-shadow:0 8px 30px rgba(0,0,0,.5); }
    .modal-card input{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a2a2a; background:#0c0c0c; color:#fff; margin:6px 0; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <img src="logo.png" alt="INTAKEE">
    </div>

    <div class="search-bar">
      <i class="fa fa-search" style="opacity:.6;"></i>
      <input id="globalSearch" type="text" placeholder="Search videos, clips, podcasts..." />
    </div>

    <div class="auth">
      <!-- UPDATED: hide login so modal never opens -->
      <button id="loginBtn" style="display:none">Login / Sign Up</button>
      <button id="logoutBtn" style="display:none;">Logout</button>
    </div>
  </header>

  <!-- Auth modal (kept but hard-hidden) -->
  <!-- UPDATED: add inline display:none to ensure it never shows -->
  <div id="authModal" class="modal" hidden style="display:none">
    <div class="modal-card">
      <h3 style="margin:0 0 10px;">Sign in</h3>
      <input id="authEmail" type="email" placeholder="Email" />
      <input id="authPass" type="password" placeholder="Password" />
      <div class="row" style="justify-content:space-between; flex-wrap:wrap;">
        <button id="authSignup" class="primary">Create account</button>
        <button id="authLogin">Log in</button>
        <button id="authGoogle" class="ghost">Continue with Google</button>
        <button id="authClose" class="ghost">Close</button>
      </div>
      <div id="authMsg" class="muted" style="margin-top:8px;"></div>
    </div>
  </div>

  <main>
    <!-- Create Post -->
    <section class="card" id="create-card">
      <div class="row">
        <input id="postText" type="text" placeholder="Say something…" />
        <input id="postFile" type="file" />
        <button id="postBtn" class="primary">Post</button>
      </div>
    </section>

    <!-- Tab sections -->
    <section id="tab-home"></section> <!-- feed renders here -->
    <section id="tab-videos"   class="card" style="display:none;">Coming soon.</section>
    <section id="tab-podcast"  class="card" style="display:none;">Coming soon.</section>
    <section id="tab-upload"   class="card" style="display:none;">Coming soon.</section>
    <section id="tab-clips"    class="card" style="display:none;">Coming soon.</section>
    <section id="tab-profile"  class="card" style="display:none;">Coming soon.</section>
    <section id="tab-settings" class="card" style="display:none;">Coming soon.</section>
  </main>

  <!-- Bottom Tab Bar -->
  <nav class="bottom-nav">
    <a href="#home"    data-tab="home" class="active"><i class="fa fa-home"></i><span>Home</span></a>
    <a href="#videos"  data-tab="videos"><i class="fa fa-video"></i><span>Videos</span></a>
    <a href="#podcast" data-tab="podcast"><i class="fa fa-podcast"></i><span>Podcast</span></a>
    <a href="#upload"  data-tab="upload"><i class="fa fa-plus-circle"></i><span>Upload</span></a>
    <a href="#clips"   data-tab="clips"><i class="fa fa-bolt"></i><span>Clips</span></a>
    <a href="#profile" data-tab="profile"><i class="fa fa-user"></i><span>Profile</span></a>
    <a href="#settings"data-tab="settings"><i class="fa fa-gear"></i><span>Settings</span></a>
  </nav>

  <!-- Firebase + App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, addDoc, collection,
      serverTimestamp, query, orderBy, limit, onSnapshot, deleteDoc,
      getDocs, startAfter
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
    import {
      getStorage, ref, uploadBytes, getDownloadURL, deleteObject
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js";
    import { firebaseConfig } from "./firebase-config.js";

    // Init
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Elements
    const loginBtn  = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const postText  = document.getElementById("postText");
    const postFile  = document.getElementById("postFile");
    const postBtn   = document.getElementById("postBtn");
    const feedEl    = document.getElementById("tab-home");

    // Modal elements (kept but unused)
    const authModal = document.getElementById("authModal");
    const authEmail = document.getElementById("authEmail");
    const authPass  = document.getElementById("authPass");
    const authSignup= document.getElementById("authSignup");
    const authLogin = document.getElementById("authLogin");
    const authClose = document.getElementById("authClose");
    const authGoogle= document.getElementById("authGoogle");
    const authMsg   = document.getElementById("authMsg");

    function openAuth(){ authModal.hidden = false; authEmail?.focus(); authMsg.textContent=""; }
    function closeAuth(){ authModal.hidden = true; if(authEmail) authEmail.value=""; if(authPass) authPass.value=""; authMsg.textContent=""; }

    // Auth
    // UPDATED: disable opening the modal
    // loginBtn.addEventListener("click", openAuth);
    logoutBtn.addEventListener("click", () => signOut(auth));
    authClose?.addEventListener("click", closeAuth);

    onAuthStateChanged(auth, async (user) => {
      const loggedIn = !!user;
      // Keep both hidden by default to avoid flashing
      loginBtn.style.display  = "none";   // stays hidden
      logoutBtn.style.display = loggedIn ? "inline-block" : "none";

      if (user) {
        const uref = doc(db, "users", user.uid);
        const snap = await getDoc(uref);
        if (!snap.exists()) {
          await setDoc(uref, {
            uid: user.uid,
            displayName: user.displayName ?? "",
            email: user.email ?? "",
            photoURL: user.photoURL ?? "",
            createdAt: serverTimestamp()
          });
        }
      }
    });

    // Helpers
    function escapeHtml(s="") {
      return s.replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }
    function detectKind(file) {
      if (!file) return { kind: "text", mime: null };
      const mime = file.type || "";
      if (mime.startsWith("image/")) return { kind: "image", mime };
      if (mime.startsWith("video/")) return { kind: "video", mime };
      if (mime.startsWith("audio/")) return { kind: "audio", mime };
      return { kind: "file", mime };
    }
    function fmtTime(ts){
      try {
        const t = ts?.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
        if(!t) return "";
        return t.toLocaleString([], { month:"short", day:"numeric", hour:"2-digit", minute:"2-digit" });
      } catch { return ""; }
    }

    // Create Post
    async function createPost({ text, file }) {
      const user = auth.currentUser;
      if (!user) { alert("Posting is locked until accounts are enabled."); return; } /* keep UI safe while auth is hidden */

      let mediaUrl = null, storagePath = null;
      let kind = "text", mime = null;

      if (file) {
        const info = detectKind(file);
        kind = info.kind; mime = info.mime;
        const folder = kind === "image" ? "images" :
                       kind === "video" ? "videos" :
                       kind === "audio" ? "audio"  : "files";
        storagePath = `uploads/${user.uid}/${folder}/${Date.now()}-${file.name}`;
        const r = ref(storage, storagePath);
        await uploadBytes(r, file);
        mediaUrl = await getDownloadURL(r);
      }

      await addDoc(collection(db, "posts"), {
        ownerId: user.uid,
        user: user.displayName ?? "",
        userPhoto: user.photoURL ?? "",
        text: (text || "").trim(),
        mediaUrl,
        storagePath,
        kind,
        mime,
        likeCount: 0,
        commentCount: 0,
        createdAt: serverTimestamp()
      });
    }

    const postBtn = document.getElementById("postBtn");
    postBtn.addEventListener("click", async () => {
      postBtn.disabled = true;
      try {
        await createPost({ text: postText.value, file: postFile.files[0] });
        postText.value = ""; postFile.value = "";
      } catch (e) { alert(e.message); }
      postBtn.disabled = false;
    });

    // Likes
    async function toggleLike(postId) {
      const u = auth.currentUser;
      if (!u) return alert("Sign in to like.");
      const likeRef = doc(db, "posts", postId, "likes", u.uid);
      const existing = await getDoc(likeRef);
      if (existing.exists()) { await deleteDoc(likeRef); }
      else { await setDoc(likeRef, { uid: u.uid, createdAt: serverTimestamp() }); }
    }
    async function getLikeCount(postId) {
      const likesSnap = await getDocs(collection(db, "posts", postId, "likes"));
      return likesSnap.size;
    }
    async function userHasLiked(postId) {
      const u = auth.currentUser; if (!u) return false;
      const likeRef = doc(db, "posts", postId, "likes", u.uid);
      const snap = await getDoc(likeRef); return snap.exists();
    }

    // Comments
    async function addComment(postId, text) {
      const u = auth.currentUser; if (!u) return alert("Sign in to comment.");
      if (!text.trim()) return;
      await addDoc(collection(db, "posts", postId, "comments"), {
        uid: u.uid, user: u.displayName ?? "", text: text.trim(), createdAt: serverTimestamp()
      });
    }
    function listenComments(postId, container) {
      const q = query(collection(db, "posts", postId, "comments"), orderBy("createdAt", "asc"), limit(50));
      return onSnapshot(q, (snap) => {
        container.innerHTML = "";
        snap.forEach((d) => {
          const c = d.data();
          const div = document.createElement("div");
          div.className = "comment";
          div.innerHTML = `<strong>${escapeHtml(c.user||"Anon")}:</strong> ${escapeHtml(c.text)}`;
          container.appendChild(div);
        });
      });
    }

    // Delete Post (owner only)
    async function deletePost(id, storagePath, ownerId) {
      const user = auth.currentUser;
      if (!user || user.uid !== ownerId) return alert("You can only delete your own posts.");
      if (!confirm("Delete this post?")) return;
      await deleteDoc(doc(db, "posts", id));
      if (storagePath) { try { await deleteObject(ref(storage, storagePath)); } catch {} }
    }

    // Feed
    const PAGE_SIZE = 20;
    function renderPostCard(d) {
      const p = d.data();
      const me = auth.currentUser?.uid;
      const wrapper = document.createElement("article");
      wrapper.className = "card post";

      const avatar = document.createElement("img");
      avatar.className = "avatar";
      avatar.src = p.userPhoto || "";
      avatar.alt = "";
      avatar.onerror = () => { avatar.style.display = "none"; };

      const content = document.createElement("div");
      const meta = document.createElement("div");
      meta.className = "meta";
      meta.innerHTML = `<strong>${escapeHtml(p.user||"Anon")}</strong><span class="muted"> · ${fmtTime(p.createdAt)}</span>`;

      const textEl = document.createElement("div");
      textEl.innerHTML = p.text ? escapeHtml(p.text) : "";

      const mediaEl = document.createElement("div");
      mediaEl.className = "media";
      if (p.mediaUrl) {
        if (p.kind === "image") mediaEl.innerHTML = `<img src="${p.mediaUrl}" alt="image">`;
        else if (p.kind === "video") mediaEl.innerHTML = `<video src="${p.mediaUrl}" controls playsinline></video>`;
        else if (p.kind === "audio") mediaEl.innerHTML = `<audio src="${p.mediaUrl}" controls></audio>`;
        else mediaEl.innerHTML = `<a href="${p.mediaUrl}" target="_blank" rel="noopener">Download file</a>`;
      } else { mediaEl.innerHTML = ""; }

      const actions = document.createElement("div");
      actions.className = "actions";

      const likeBtn = document.createElement("button");
      likeBtn.className = "ghost";
      likeBtn.textContent = "♥ Like";
      likeBtn.addEventListener("click", () => toggleLike(d.id));

      const likeCountEl = document.createElement("span");
      likeCountEl.className = "muted";
      likeCountEl.textContent = "0 likes";

      const commentInput = document.createElement("input");
      commentInput.type = "text"; commentInput.placeholder = "Write a comment…"; commentInput.style.flex = "1";

      const commentBtn = document.createElement("button");
      commentBtn.textContent = "Comment";
      commentBtn.addEventListener("click", async () => {
        await addComment(d.id, commentInput.value);
        commentInput.value = "";
      });

      const commentsWrap = document.createElement("div");

      if (me && me === p.ownerId) {
        const delBtn = document.createElement("button");
        delBtn.className = "danger";
        delBtn.textContent = "Delete";
        delBtn.addEventListener("click", () => deletePost(d.id, p.storagePath, p.ownerId));
        actions.appendChild(delBtn);
      }

      actions.appendChild(likeBtn);
      actions.appendChild(likeCountEl);
      actions.appendChild(commentInput);
      actions.appendChild(commentBtn);

      content.appendChild(meta);
      if (p.text) content.appendChild(textEl);
      if (p.mediaUrl) content.appendChild(mediaEl);
      content.appendChild(actions);
      content.appendChild(commentsWrap);

      wrapper.appendChild(avatar);
      wrapper.appendChild(content);

      (async () => {
        const count = await getLikeCount(d.id);
        likeCountEl.textContent = `${count} ${count===1?"like":"likes"}`;
        if (await userHasLiked(d.id)) {
          likeBtn.textContent = "♥ Liked";
          likeBtn.style.borderColor = "#ff3b3b";
          likeBtn.style.color = "#ff3b3b";
        }
      })();

      listenComments(d.id, commentsWrap);
      return wrapper;
    }

    function renderBatch(docs, append=false) {
      if (!append) feedEl.innerHTML = "";
      docs.forEach(d => feedEl.appendChild(renderPostCard(d)));
    }

    const firstPageQuery = query(collection(db, "posts"), orderBy("createdAt", "desc"), limit(PAGE_SIZE));
    onSnapshot(firstPageQuery, (snap) => {
      const docs = snap.docs;
      if (!docs.length) {
        feedEl.innerHTML = '<div class="muted card">No posts yet.</div>';
        return;
      }
      renderBatch(docs, false);
    });

    // Tabs (SPA)
    const links = Array.from(document.querySelectorAll('.bottom-nav a'));
    const sections = {
      home:    document.getElementById('tab-home'),
      videos:  document.getElementById('tab-videos'),
      podcast: document.getElementById('tab-podcast'),
      upload:  document.getElementById('tab-upload'),
      clips:   document.getElementById('tab-clips'),
      profile: document.getElementById('tab-profile'),
      settings:document.getElementById('tab-settings'),
    };
    function setTab(key){
      Object.entries(sections).forEach(([k,el]) => { el.style.display = (k===key) ? '' : 'none'; });
      links.forEach(a => a.classList.toggle('active', a.dataset.tab===key));
      window.scrollTo({top:0, behavior:'smooth'});
    }
    links.forEach(a => a.addEventListener('click', (e) => { e.preventDefault(); setTab(a.dataset.tab); }));
    setTab('home');
  </script>
</body>
</html>
